name: foundry
on: {workflow_dispatch, push: {branches: [main]}}
jobs:
  build_v2:
    strategy:
      fail-fast: false
      matrix:
        image:
          - curl
          - nix
          - python311
          - pypi
          # - python312
          - k8s_aws
          - k8s_gcp
          - zaddy
    name: foundry-${{ matrix.image }}
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4.1.2
      - uses: cachix/install-nix-action@v26
      - uses: cachix/cachix-action@master
        with:
          name: jacobi
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - run: nix run .#skopeo -- login -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }} ghcr.io
      - run: nix run .#foundry.${{ matrix.image }}.copyToRegistry
      - run: |
          export IMAGE="docker://$(nix eval --raw .#foundry.${{ matrix.image }}.imageName)"
          export TAG="$(nix eval --raw .#foundry.${{ matrix.image }}.imageTag)"
          skopeo --insecure-policy copy "$IMAGE:$TAG" "$IMAGE:$(date +"%F")"
          skopeo --insecure-policy copy "$IMAGE:$TAG" "$IMAGE:latest"
